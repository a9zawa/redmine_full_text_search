#!/usr/bin/env ruby

require "optparse"
require "json"

config_dir = File.expand_path("../../../../config",  __FILE__)
APP_PATH = File.join(config_dir, "application")
require APP_PATH
Rails.application.require_environment!

plugin = Redmine::Plugin.find(:full_text_search)

filter = FullTextSearch::SimilarWordsFilter.new

parser = OptionParser.new
parser.version = plugin.version
parser.on("--cosign-threshold=THRESHOLD", Float,
          "Use THRESHOLD for cosign similarity",
          "(#{filter.cosine_threshold})") do |threshold|
  filter.cosine_threshold = threshold
end
parser.on("--engine=ENGINE",
          "Use only records that is generated by ENGINE") do |engine|
  filter.engine = engine
end

filtered_records = filter.run(JSON.parse(ARGF.read))
puts(JSON.pretty_generate(filtered_records))
