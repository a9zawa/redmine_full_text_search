#!/usr/bin/env ruby

if ARGV.size != 1
  $stderr.puts("Usage: #{$0} identifier")
  $stderr.puts(" e.g.: #{$0} my-project")
  exit(false)
end

config_dir = File.expand_path("../../../../config",  __FILE__)
APP_PATH = File.join(config_dir, "application")
require APP_PATH
Rails.application.require_environment!

identifier = ARGV[0]
project = Project.find_by_identifier!(identifier)
offset = 0
limit = 10000
puts("[")
i = 0
loop do
  arguments = {
    "filter" => "project_id == #{project.id}",
    "offset" => offset.to_s,
    "limit" => limit.to_s,
  }
  command = Groonga::Command::Select.new("select", arguments)
  response = FullTextSearch::Target.select(command)
  records = response.records
  records.each do |record|
    puts(",") if i > 0
    print(record.to_json)
    i += 1
  end
  offset += records.size
  break if response.n_hits == i
end
puts if i > 0
puts("]")
